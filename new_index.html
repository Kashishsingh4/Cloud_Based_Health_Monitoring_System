<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Health Monitoring Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
 
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      padding: 20px;
      background: #eef2f7;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    h1 {
      font-weight: 600;
      color: #343a40;
    }

    .card {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    }

    .status-badge {
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 0.9rem;
    }

    #alertsArea div {
      margin-bottom: 5px;
    }

    footer {
      text-align: center;
      font-size: 0.85rem;
      color: #6c757d;
    }

    input.form-control {
      border-radius: 10px;
    }

    button {
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="d-flex align-items-center mb-4">
      <h1 class="me-auto">Health Monitor</h1>
    </div>

    <!-- User input section -->
    <!-- User input section -->
    <div class="row g-3 mb-4 align-items-end">
      <div class="col-md-6">
        <label class="form-label">Enter Department</label>
        <input id="departmentInput" class="form-control" placeholder="e.g., Cardiology, ICU, General" />
      </div>
      <div class="col-md-6">
        <label class="form-label">Enter Patient ID</label>
        <div class="input-group">
          <input id="patientInput" class="form-control" placeholder="e.g., P0001" />
          <button id="viewBtn" class="btn btn-primary">View Patient</button>
        </div>
      </div>
    </div>


    <div class="row">
      <div class="col-lg-4 mb-4">
        <div class="card p-4 bg-white">
          <h5 id="patientName" class="mb-3">Patient: —</h5>
          <div class="mb-3">
            <span id="statusBadge" class="status-badge bg-secondary text-white">No Data</span>
            <small class="text-muted ms-2" id="lastSeen"></small>
          </div>
          <ul class="list-group list-group-flush mb-3">
            <li class="list-group-item">Heart Rate: <span id="hrVal">—</span> bpm</li>
            <li class="list-group-item">SpO₂: <span id="spo2Val">—</span> %</li>
            <li class="list-group-item">Temp: <span id="tempVal">—</span> °C</li>
          </ul>
          <div>
            <h6>Alerts</h6>
            <div id="alertsArea">No alerts</div>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="col-lg-8 mb-4">
        <div class="card p-4 bg-white">
          <canvas id="hrChart" height="140"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://w76luodf64.execute-api.ap-south-1.amazonaws.com/prod/vitals";

    const deptInput = document.getElementById('departmentInput');
    const patientInput = document.getElementById('patientInput');
    const viewBtn = document.getElementById('viewBtn');

    const patientNameEl = document.getElementById('patientName');
    const statusBadge = document.getElementById('statusBadge');
    const lastSeen = document.getElementById('lastSeen');
    const hrVal = document.getElementById('hrVal');
    const spo2Val = document.getElementById('spo2Val');
    const tempVal = document.getElementById('tempVal');
    const alertsArea = document.getElementById('alertsArea');

    let currentPatient = null;
    let refreshInterval = null;
    let hrChart;
    let chartData = { labels: [], datasets: [{ label: 'Heart Rate', data: [], borderColor: '#d9534f', tension: 0.2 }] };

    function initChart() {
      const ctx = document.getElementById('hrChart').getContext('2d');
      hrChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          plugins: { legend: { display: true, position: 'top' } },
          scales: { x: { display: true }, y: { beginAtZero: false } }
        }
      });
    }

    async function fetchVitals(pid) {
      if (!API_BASE) { console.warn('API not configured'); return []; }
      try {
        const url = API_BASE + '?patientId=' + encodeURIComponent(pid) + '&limit=20';
        const resp = await axios.get(url);
        return resp.data || [];
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    function updateSummary(latest) {
      if (!latest) {
        patientNameEl.textContent = 'Patient: —';
        statusBadge.textContent = 'No Data';
        statusBadge.className = 'status-badge bg-secondary text-white';
        lastSeen.textContent = '';
        hrVal.textContent = '—';
        spo2Val.textContent = '—';
        tempVal.textContent = '—';
        alertsArea.innerHTML = 'No alerts';
        return;
      }
      patientNameEl.textContent = `Patient: ${latest.patientId} (${latest.department || deptInput.value})`;
      lastSeen.textContent = new Date(latest.ts).toLocaleString();
      hrVal.textContent = latest.hr;
      spo2Val.textContent = latest.spo2;
      tempVal.textContent = latest.temp;
      let status = 'OK', cls = 'bg-success';
      if (latest.hr >= 120 || latest.spo2 <= 90 || latest.temp >= 38) { status = 'CRITICAL'; cls = 'bg-danger'; }
      else if (latest.hr > 100 || latest.spo2 < 95 || latest.temp > 37.2) { status = 'Warning'; cls = 'bg-warning text-dark'; }
      statusBadge.textContent = status; statusBadge.className = 'status-badge ' + cls;
    }

    function updateChart(items) {
      chartData.labels = items.map(i => i.ts).reverse();
      chartData.datasets[0].data = items.map(i => i.hr).reverse();
      hrChart.update();
    }

    async function refreshView() {
      if (!currentPatient) return;
      const items = await fetchVitals(currentPatient);
      if (!items || items.length === 0) { updateSummary(null); updateChart([]); return; }
      updateChart(items);
      updateSummary(items[0]);
      alertsArea.innerHTML = '';
      if (items[0].hr >= 120) alertsArea.innerHTML += '<div class="text-danger">High HR detected</div>';
      if (items[0].spo2 <= 90) alertsArea.innerHTML += '<div class="text-danger">Low SpO₂ detected</div>';
      if (items[0].temp >= 38) alertsArea.innerHTML += '<div class="text-danger">High Temp detected</div>';
      if (alertsArea.innerHTML === '') alertsArea.innerHTML = '<div class="text-success">No alerts</div>';
    }

    /* Events */
    viewBtn.addEventListener('click', () => {
      const dept = deptInput.value.trim();
      const pid = patientInput.value.trim();
      if (!dept || !pid) {
        alert("Please enter both Department and Patient ID!");
        return;
      }
      currentPatient = pid;
      if (refreshInterval) clearInterval(refreshInterval);
      refreshView();
      refreshInterval = setInterval(refreshView, 5000);
    });

    /* Init */
    initChart();
  </script>
</body>

</html>